<!DOCTYPE html>
<html>
<head>
<title>Simple viewer for Vineyards time map (with OpenLayers 3)</title>
<meta name="description" content="Simple viewer for Vineyards time map (with OpenLayers 3)" />
<meta name="keywords" content="time-map, openlayers 3, vineyard, netCDF" />
<meta name="authors" content="Haitao Wang, CGIT" />
<script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="http://openlayers.org/en/v3.9.0/css/ol.css" type="text/css">
<script src="http://openlayers.org/en/v3.9.0/build/ol.js"></script>

<style>
#layertree li > span {
  cursor: pointer;
}

</style>
</head>
<body>
<div class="container-fluid">
<h2>Simple viewer for Vineyards time-map</h2>
    <blockquote>
    <h4>Proposed Solution</h4>
	    <ol>
	    <li>Request all images within a certain time-period from WMS, and add to an empty netCDF Layer group</li>
	    <li>Sort the time stamps which are later used to create nodes in a time slider;</li>
	    <li>The time slider triggers an event that modify the corresponding layers using one of these methods:<br>
	     (1) add / remove layer (2) change layer order: move up / down (3) switch layer visibility (4) toggle layer opacity ;</li>
	    <li>(Optional) Build a play/loop function to animate the sequence </li>
	    <footer>update: Sep 09, 2015</footer>
	    </ol>
    </blockquote>
<div class="row-fluid">
  <div class="span6">
    <div id="map" class="map"></div>
  </div>
  <div id="layertree" class="span6">
    <h3>Layer Visibility & Opacity</h3>
    <ul>
      <li><span>netCDF Layer group</span>
        <fieldset id="layer1">
          <label class="checkbox" for="visible1">
            <input id="visible1" class="visible" type="checkbox"/>visibility
          </label>
          <label>opacity</label>
          <input class="opacity" type="range" min="0" max="1" step="0.1"/>
        </fieldset>
        <ul>
          <li><span>netCDF Layer 1</span>
            <fieldset id="layer10">
              <label class="checkbox" for="visible10">
                <input id="visible10" class="visible" type="checkbox"/>visibility
              </label>
              <label>opacity</label>
              <input class="opacity" type="range" min="0" max="1" step="0.1"/>
            </fieldset>
          </li>
          <li><span>netCDF Layer 2</span>
            <fieldset id="layer11">
              <label class="checkbox" for="visible11">
                <input id="visible11" class="visible" type="checkbox"/>visibility
              </label>
              <label>opacity</label>
              <input class="opacity" type="range" min="0" max="1" step="0.1"/>
            </fieldset>
          </li>
        </ul>
      </li>
      
      <li><span>BaseLayer</span>
        <fieldset id="layer0">
          <label class="checkbox" for="visible0">
            <input id="visible0" class="visible" type="checkbox"/>visibility
          </label>
          <label>opacity</label>
          <input class="opacity" type="range" min="0" max="1" step="0.1"/>
        </fieldset>
      </li>
    </ul>
  </div>
</div>

</div>
<script>
// define mapconfig
var mapConfig = {'styles':{} };
mapConfig.defaultView = {zoom: 6, center: [-78.56, 38.04]};
mapConfig.projection = 'EPSG:3857';

// define map layers (baselayer, sample netCDF layers)
var baseLayers = new ol.layer.Tile({
    source: new ol.source.MapQuest({layer: 'sat'})
});

var netcdfLayers = new ol.layer.Group({
	title: 'netcdf layer group',
	layers: [
		new ol.layer.Image({
			title: 'netcdf layer 1',
			source: new ol.source.ImageWMS({
				 url: 'http://198.82.152.38:8080/geoserver/ows',
				 params: {
					'layers': 'netCDFtesting:devWDIR',
					'bbox': '-83.807,36.433,-74.91299999999998,39.82899999999999',
					'width': '768',
					'height': '330',
					'format': 'image/png',
					'crs': 'EPSG:4326',
					'time': '2015-08-24T00:00:00.000Z'
				}
			})
		}),
		new ol.layer.Image({
			title: 'netcdf layer 2',
			source: new ol.source.ImageWMS({
				 url: 'http://198.82.152.38:8080/geoserver/ows',
				 params: {
					'layers': 'netCDFtesting:devWDIR',
					'bbox': '-83.807,36.433,-74.91299999999998,39.82899999999999',
					'width': '768',
					'height': '330',
					'format': 'image/png',
					'crs': 'EPSG:4326',
					'time': '2015-08-25T00:00:00.000Z'
				}
			})
		})
	]
});

// define map view
var view = new ol.View({
	zoom : mapConfig.defaultView.zoom,
	//maxZoom: 12,
	center : ol.proj.transform(mapConfig.defaultView.center, 'EPSG:4326', mapConfig.projection),
	projection: mapConfig.projection
});


//Create a map and add controls
var map = new ol.Map({
	target : 'map',
	///layers: drawLayers must be the last one
	layers : [baseLayers, netcdfLayers],
	view : view
});

function bindInputs(layerid, layer) {
  var visibilityInput = $(layerid + ' input.visible');
  visibilityInput.on('change', function() {
    layer.setVisible(this.checked);
  });
  visibilityInput.prop('checked', layer.getVisible());

  //$.each(['opacity', 'hue', 'saturation', 'contrast', 'brightness'],
  $.each(['opacity'],
      function(i, v) {
        var input = $(layerid + ' input.' + v);
        input.on('input change', function() {
          layer.set(v, parseFloat(this.value));
        });
        input.val(String(layer.get(v)));
      }
  );
}
map.getLayers().forEach(function(layer, i) {
  bindInputs('#layer' + i, layer);
  if (layer instanceof ol.layer.Group) {
    layer.getLayers().forEach(function(sublayer, j) {
      bindInputs('#layer' + i + j, sublayer);
    });
  }
});

/*
$('#layertree li > span').click(function() {
  $(this).siblings('fieldset').toggle();
}).siblings('fieldset').hide();
*/

</script>
</body>
</html>